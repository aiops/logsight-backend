import { Injectable, Inject, PLATFORM_ID, Optional } from '@angular/core';
import { DOCUMENT, isPlatformBrowser } from '@angular/common';
import { BehaviorSubject, from, EMPTY, zip, throwError } from 'rxjs';
import { catchError, tap, map, switchMap, filter, take } from 'rxjs/operators';
import { HIGHLIGHT_OPTIONS } from './highlight.model';
import * as i0 from "@angular/core";
import * as i1 from "@angular/common";
import * as i2 from "./highlight.model";
// @dynamic
export class HighlightLoader {
    constructor(doc, platformId, _options) {
        this._options = _options;
        // Stream that emits when hljs library is loaded and ready to use
        this._ready = new BehaviorSubject(null);
        this.ready = this._ready.asObservable().pipe(filter((hljs) => !!hljs), map((hljs) => hljs), take(1));
        // Check if hljs is already available
        if (isPlatformBrowser(platformId) && doc.defaultView.hljs) {
            this._ready.next(doc.defaultView.hljs);
        }
        else {
            // Load hljs library
            this._loadLibrary().pipe(switchMap((hljs) => {
                if (this._options && this._options.lineNumbersLoader) {
                    // Make hljs available on window object (required for the line numbers library)
                    doc.defaultView.hljs = hljs;
                    // Load line numbers library
                    return this.loadLineNumbers().pipe(tap(() => this._ready.next(hljs)));
                }
                else {
                    this._ready.next(hljs);
                    return EMPTY;
                }
            }), catchError((e) => {
                console.error('[HLJS] ', e);
                return EMPTY;
            })).subscribe();
        }
    }
    /**
     * Lazy-Load highlight.js library
     */
    _loadLibrary() {
        if (this._options) {
            if (this._options.fullLibraryLoader && this._options.coreLibraryLoader) {
                return throwError('The full library and the core library were imported, only one of them should be imported!');
            }
            if (this._options.fullLibraryLoader && this._options.languages) {
                return throwError('The highlighting languages were imported they are not needed!');
            }
            if (this._options.coreLibraryLoader && !this._options.languages) {
                return throwError('The highlighting languages were not imported!');
            }
            if (!this._options.coreLibraryLoader && this._options.languages) {
                return throwError('The core library was not imported!');
            }
            if (this._options.fullLibraryLoader) {
                return this.loadFullLibrary();
            }
            if (this._options.coreLibraryLoader && this._options.languages && Object.keys(this._options.languages).length) {
                return this.loadCoreLibrary().pipe(switchMap((hljs) => this._loadLanguages(hljs)));
            }
        }
        return throwError('Highlight.js library was not imported!');
    }
    /**
     * Lazy-load highlight.js languages
     */
    _loadLanguages(hljs) {
        const languages = Object.entries(this._options.languages).map(([langName, langLoader]) => importModule(langLoader()).pipe(tap((langFunc) => hljs.registerLanguage(langName, langFunc))));
        return zip(...languages).pipe(map(() => hljs));
    }
    /**
     * Import highlight.js core library
     */
    loadCoreLibrary() {
        return importModule(this._options.coreLibraryLoader());
    }
    /**
     * Import highlight.js library with all languages
     */
    loadFullLibrary() {
        return importModule(this._options.fullLibraryLoader());
    }
    /**
     * Import line numbers library
     */
    loadLineNumbers() {
        return importModule(this._options.lineNumbersLoader());
    }
}
HighlightLoader.ɵprov = i0.ɵɵdefineInjectable({ factory: function HighlightLoader_Factory() { return new HighlightLoader(i0.ɵɵinject(i1.DOCUMENT), i0.ɵɵinject(i0.PLATFORM_ID), i0.ɵɵinject(i2.HIGHLIGHT_OPTIONS, 8)); }, token: HighlightLoader, providedIn: "root" });
HighlightLoader.decorators = [
    { type: Injectable, args: [{
                providedIn: 'root'
            },] }
];
HighlightLoader.ctorParameters = () => [
    { type: undefined, decorators: [{ type: Inject, args: [DOCUMENT,] }] },
    { type: Object, decorators: [{ type: Inject, args: [PLATFORM_ID,] }] },
    { type: undefined, decorators: [{ type: Optional }, { type: Inject, args: [HIGHLIGHT_OPTIONS,] }] }
];
/**
 * Map loader response to module object
 */
const importModule = (moduleLoader) => {
    return from(moduleLoader).pipe(filter((module) => !!module && !!module.default), map((module) => module.default));
};
const ɵ0 = importModule;
export { ɵ0 };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaGlnaGxpZ2h0LmxvYWRlci5qcyIsInNvdXJjZVJvb3QiOiIuLi8uLi8uLi9wcm9qZWN0cy9uZ3gtaGlnaGxpZ2h0anMvc3JjLyIsInNvdXJjZXMiOlsibGliL2hpZ2hsaWdodC5sb2FkZXIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLEVBQUUsV0FBVyxFQUFFLFFBQVEsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUMxRSxPQUFPLEVBQUUsUUFBUSxFQUFFLGlCQUFpQixFQUFFLE1BQU0saUJBQWlCLENBQUM7QUFDOUQsT0FBTyxFQUFFLGVBQWUsRUFBYyxJQUFJLEVBQUUsS0FBSyxFQUFFLEdBQUcsRUFBRSxVQUFVLEVBQUUsTUFBTSxNQUFNLENBQUM7QUFDakYsT0FBTyxFQUFFLFVBQVUsRUFBRSxHQUFHLEVBQUUsR0FBRyxFQUFFLFNBQVMsRUFBRSxNQUFNLEVBQUUsSUFBSSxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFDL0UsT0FBTyxFQUFFLGlCQUFpQixFQUFzQyxNQUFNLG1CQUFtQixDQUFDOzs7O0FBRTFGLFdBQVc7QUFJWCxNQUFNLE9BQU8sZUFBZTtJQVMxQixZQUE4QixHQUFRLEVBQ0wsVUFBa0IsRUFDUSxRQUEwQjtRQUExQixhQUFRLEdBQVIsUUFBUSxDQUFrQjtRQVZyRixpRUFBaUU7UUFDaEQsV0FBTSxHQUFHLElBQUksZUFBZSxDQUEwQixJQUFJLENBQUMsQ0FBQztRQUNwRSxVQUFLLEdBQWlDLElBQUksQ0FBQyxNQUFNLENBQUMsWUFBWSxFQUFFLENBQUMsSUFBSSxDQUM1RSxNQUFNLENBQUMsQ0FBQyxJQUE2QixFQUFFLEVBQUUsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLEVBQ2pELEdBQUcsQ0FBQyxDQUFDLElBQTZCLEVBQUUsRUFBRSxDQUFDLElBQXdCLENBQUMsRUFDaEUsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUNSLENBQUM7UUFLQSxxQ0FBcUM7UUFDckMsSUFBSSxpQkFBaUIsQ0FBQyxVQUFVLENBQUMsSUFBSSxHQUFHLENBQUMsV0FBVyxDQUFDLElBQUksRUFBRTtZQUN6RCxJQUFJLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsV0FBVyxDQUFDLElBQUksQ0FBQyxDQUFDO1NBQ3hDO2FBQU07WUFDTCxvQkFBb0I7WUFDcEIsSUFBSSxDQUFDLFlBQVksRUFBRSxDQUFDLElBQUksQ0FDdEIsU0FBUyxDQUFDLENBQUMsSUFBc0IsRUFBRSxFQUFFO2dCQUNuQyxJQUFJLElBQUksQ0FBQyxRQUFRLElBQUksSUFBSSxDQUFDLFFBQVEsQ0FBQyxpQkFBaUIsRUFBRTtvQkFDcEQsK0VBQStFO29CQUMvRSxHQUFHLENBQUMsV0FBVyxDQUFDLElBQUksR0FBRyxJQUFJLENBQUM7b0JBQzVCLDRCQUE0QjtvQkFDNUIsT0FBTyxJQUFJLENBQUMsZUFBZSxFQUFFLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxHQUFHLEVBQUUsQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUM7aUJBQ3ZFO3FCQUFNO29CQUNMLElBQUksQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDO29CQUN2QixPQUFPLEtBQUssQ0FBQztpQkFDZDtZQUNILENBQUMsQ0FBQyxFQUNGLFVBQVUsQ0FBQyxDQUFDLENBQU0sRUFBRSxFQUFFO2dCQUNwQixPQUFPLENBQUMsS0FBSyxDQUFDLFNBQVMsRUFBRSxDQUFDLENBQUMsQ0FBQztnQkFDNUIsT0FBTyxLQUFLLENBQUM7WUFDZixDQUFDLENBQUMsQ0FDSCxDQUFDLFNBQVMsRUFBRSxDQUFDO1NBQ2Y7SUFDSCxDQUFDO0lBRUQ7O09BRUc7SUFDSyxZQUFZO1FBQ2xCLElBQUksSUFBSSxDQUFDLFFBQVEsRUFBRTtZQUNqQixJQUFJLElBQUksQ0FBQyxRQUFRLENBQUMsaUJBQWlCLElBQUksSUFBSSxDQUFDLFFBQVEsQ0FBQyxpQkFBaUIsRUFBRTtnQkFDdEUsT0FBTyxVQUFVLENBQUMsMkZBQTJGLENBQUMsQ0FBQzthQUNoSDtZQUNELElBQUksSUFBSSxDQUFDLFFBQVEsQ0FBQyxpQkFBaUIsSUFBSSxJQUFJLENBQUMsUUFBUSxDQUFDLFNBQVMsRUFBRTtnQkFDOUQsT0FBTyxVQUFVLENBQUMsK0RBQStELENBQUMsQ0FBQzthQUNwRjtZQUNELElBQUksSUFBSSxDQUFDLFFBQVEsQ0FBQyxpQkFBaUIsSUFBSSxDQUFDLElBQUksQ0FBQyxRQUFRLENBQUMsU0FBUyxFQUFFO2dCQUMvRCxPQUFPLFVBQVUsQ0FBQywrQ0FBK0MsQ0FBQyxDQUFDO2FBQ3BFO1lBQ0QsSUFBSSxDQUFDLElBQUksQ0FBQyxRQUFRLENBQUMsaUJBQWlCLElBQUksSUFBSSxDQUFDLFFBQVEsQ0FBQyxTQUFTLEVBQUU7Z0JBQy9ELE9BQU8sVUFBVSxDQUFDLG9DQUFvQyxDQUFDLENBQUM7YUFDekQ7WUFDRCxJQUFJLElBQUksQ0FBQyxRQUFRLENBQUMsaUJBQWlCLEVBQUU7Z0JBQ25DLE9BQU8sSUFBSSxDQUFDLGVBQWUsRUFBRSxDQUFDO2FBQy9CO1lBQ0QsSUFBSSxJQUFJLENBQUMsUUFBUSxDQUFDLGlCQUFpQixJQUFJLElBQUksQ0FBQyxRQUFRLENBQUMsU0FBUyxJQUFJLE1BQU0sQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxTQUFTLENBQUMsQ0FBQyxNQUFNLEVBQUU7Z0JBQzdHLE9BQU8sSUFBSSxDQUFDLGVBQWUsRUFBRSxDQUFDLElBQUksQ0FBQyxTQUFTLENBQUMsQ0FBQyxJQUFzQixFQUFFLEVBQUUsQ0FBQyxJQUFJLENBQUMsY0FBYyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQzthQUN0RztTQUNGO1FBQ0QsT0FBTyxVQUFVLENBQUMsd0NBQXdDLENBQUMsQ0FBQztJQUM5RCxDQUFDO0lBRUQ7O09BRUc7SUFDSyxjQUFjLENBQUMsSUFBc0I7UUFDM0MsTUFBTSxTQUFTLEdBQUcsTUFBTSxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLFNBQVUsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsUUFBUSxFQUFFLFVBQVUsQ0FBQyxFQUFFLEVBQUUsQ0FDeEYsWUFBWSxDQUFDLFVBQVUsRUFBRSxDQUFDLENBQUMsSUFBSSxDQUM3QixHQUFHLENBQUMsQ0FBQyxRQUFhLEVBQUUsRUFBRSxDQUFDLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxRQUFRLEVBQUUsUUFBUSxDQUFDLENBQUMsQ0FDbEUsQ0FDRixDQUFDO1FBQ0YsT0FBTyxHQUFHLENBQUMsR0FBRyxTQUFTLENBQUMsQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLEdBQUcsRUFBRSxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUM7SUFDakQsQ0FBQztJQUdEOztPQUVHO0lBQ0ssZUFBZTtRQUNyQixPQUFPLFlBQVksQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLGlCQUFrQixFQUFFLENBQUMsQ0FBQztJQUMxRCxDQUFDO0lBRUQ7O09BRUc7SUFDSyxlQUFlO1FBQ3JCLE9BQU8sWUFBWSxDQUFDLElBQUksQ0FBQyxRQUFRLENBQUMsaUJBQWtCLEVBQUUsQ0FBQyxDQUFDO0lBQzFELENBQUM7SUFHRDs7T0FFRztJQUNLLGVBQWU7UUFDckIsT0FBTyxZQUFZLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxpQkFBa0IsRUFBRSxDQUFDLENBQUM7SUFDMUQsQ0FBQzs7OztZQXBHRixVQUFVLFNBQUM7Z0JBQ1YsVUFBVSxFQUFFLE1BQU07YUFDbkI7Ozs0Q0FVYyxNQUFNLFNBQUMsUUFBUTt5Q0FDZixNQUFNLFNBQUMsV0FBVzs0Q0FDbEIsUUFBUSxZQUFJLE1BQU0sU0FBQyxpQkFBaUI7O0FBeUZuRDs7R0FFRztBQUNILE1BQU0sWUFBWSxHQUFHLENBQUMsWUFBMEIsRUFBbUIsRUFBRTtJQUNuRSxPQUFPLElBQUksQ0FBQyxZQUFZLENBQUMsQ0FBQyxJQUFJLENBQzVCLE1BQU0sQ0FBQyxDQUFDLE1BQVcsRUFBRSxFQUFFLENBQUMsQ0FBQyxDQUFDLE1BQU0sSUFBSSxDQUFDLENBQUMsTUFBTSxDQUFDLE9BQU8sQ0FBQyxFQUNyRCxHQUFHLENBQUMsQ0FBQyxNQUFXLEVBQUUsRUFBRSxDQUFDLE1BQU0sQ0FBQyxPQUFPLENBQUMsQ0FDckMsQ0FBQztBQUNKLENBQUMsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEluamVjdGFibGUsIEluamVjdCwgUExBVEZPUk1fSUQsIE9wdGlvbmFsIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyBET0NVTUVOVCwgaXNQbGF0Zm9ybUJyb3dzZXIgfSBmcm9tICdAYW5ndWxhci9jb21tb24nO1xuaW1wb3J0IHsgQmVoYXZpb3JTdWJqZWN0LCBPYnNlcnZhYmxlLCBmcm9tLCBFTVBUWSwgemlwLCB0aHJvd0Vycm9yIH0gZnJvbSAncnhqcyc7XG5pbXBvcnQgeyBjYXRjaEVycm9yLCB0YXAsIG1hcCwgc3dpdGNoTWFwLCBmaWx0ZXIsIHRha2UgfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XG5pbXBvcnQgeyBISUdITElHSFRfT1BUSU9OUywgSGlnaGxpZ2h0TGlicmFyeSwgSGlnaGxpZ2h0T3B0aW9ucyB9IGZyb20gJy4vaGlnaGxpZ2h0Lm1vZGVsJztcblxuLy8gQGR5bmFtaWNcbkBJbmplY3RhYmxlKHtcbiAgcHJvdmlkZWRJbjogJ3Jvb3QnXG59KVxuZXhwb3J0IGNsYXNzIEhpZ2hsaWdodExvYWRlciB7XG4gIC8vIFN0cmVhbSB0aGF0IGVtaXRzIHdoZW4gaGxqcyBsaWJyYXJ5IGlzIGxvYWRlZCBhbmQgcmVhZHkgdG8gdXNlXG4gIHByaXZhdGUgcmVhZG9ubHkgX3JlYWR5ID0gbmV3IEJlaGF2aW9yU3ViamVjdDxIaWdobGlnaHRMaWJyYXJ5IHwgbnVsbD4obnVsbCk7XG4gIHJlYWRvbmx5IHJlYWR5OiBPYnNlcnZhYmxlPEhpZ2hsaWdodExpYnJhcnk+ID0gdGhpcy5fcmVhZHkuYXNPYnNlcnZhYmxlKCkucGlwZShcbiAgICBmaWx0ZXIoKGhsanM6IEhpZ2hsaWdodExpYnJhcnkgfCBudWxsKSA9PiAhIWhsanMpLFxuICAgIG1hcCgoaGxqczogSGlnaGxpZ2h0TGlicmFyeSB8IG51bGwpID0+IGhsanMgYXMgSGlnaGxpZ2h0TGlicmFyeSksXG4gICAgdGFrZSgxKVxuICApO1xuXG4gIGNvbnN0cnVjdG9yKEBJbmplY3QoRE9DVU1FTlQpIGRvYzogYW55LFxuICAgICAgICAgICAgICBASW5qZWN0KFBMQVRGT1JNX0lEKSBwbGF0Zm9ybUlkOiBvYmplY3QsXG4gICAgICAgICAgICAgIEBPcHRpb25hbCgpIEBJbmplY3QoSElHSExJR0hUX09QVElPTlMpIHByaXZhdGUgX29wdGlvbnM6IEhpZ2hsaWdodE9wdGlvbnMpIHtcbiAgICAvLyBDaGVjayBpZiBobGpzIGlzIGFscmVhZHkgYXZhaWxhYmxlXG4gICAgaWYgKGlzUGxhdGZvcm1Ccm93c2VyKHBsYXRmb3JtSWQpICYmIGRvYy5kZWZhdWx0Vmlldy5obGpzKSB7XG4gICAgICB0aGlzLl9yZWFkeS5uZXh0KGRvYy5kZWZhdWx0Vmlldy5obGpzKTtcbiAgICB9IGVsc2Uge1xuICAgICAgLy8gTG9hZCBobGpzIGxpYnJhcnlcbiAgICAgIHRoaXMuX2xvYWRMaWJyYXJ5KCkucGlwZShcbiAgICAgICAgc3dpdGNoTWFwKChobGpzOiBIaWdobGlnaHRMaWJyYXJ5KSA9PiB7XG4gICAgICAgICAgaWYgKHRoaXMuX29wdGlvbnMgJiYgdGhpcy5fb3B0aW9ucy5saW5lTnVtYmVyc0xvYWRlcikge1xuICAgICAgICAgICAgLy8gTWFrZSBobGpzIGF2YWlsYWJsZSBvbiB3aW5kb3cgb2JqZWN0IChyZXF1aXJlZCBmb3IgdGhlIGxpbmUgbnVtYmVycyBsaWJyYXJ5KVxuICAgICAgICAgICAgZG9jLmRlZmF1bHRWaWV3LmhsanMgPSBobGpzO1xuICAgICAgICAgICAgLy8gTG9hZCBsaW5lIG51bWJlcnMgbGlicmFyeVxuICAgICAgICAgICAgcmV0dXJuIHRoaXMubG9hZExpbmVOdW1iZXJzKCkucGlwZSh0YXAoKCkgPT4gdGhpcy5fcmVhZHkubmV4dChobGpzKSkpO1xuICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICB0aGlzLl9yZWFkeS5uZXh0KGhsanMpO1xuICAgICAgICAgICAgcmV0dXJuIEVNUFRZO1xuICAgICAgICAgIH1cbiAgICAgICAgfSksXG4gICAgICAgIGNhdGNoRXJyb3IoKGU6IGFueSkgPT4ge1xuICAgICAgICAgIGNvbnNvbGUuZXJyb3IoJ1tITEpTXSAnLCBlKTtcbiAgICAgICAgICByZXR1cm4gRU1QVFk7XG4gICAgICAgIH0pXG4gICAgICApLnN1YnNjcmliZSgpO1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBMYXp5LUxvYWQgaGlnaGxpZ2h0LmpzIGxpYnJhcnlcbiAgICovXG4gIHByaXZhdGUgX2xvYWRMaWJyYXJ5KCk6IE9ic2VydmFibGU8YW55PiB7XG4gICAgaWYgKHRoaXMuX29wdGlvbnMpIHtcbiAgICAgIGlmICh0aGlzLl9vcHRpb25zLmZ1bGxMaWJyYXJ5TG9hZGVyICYmIHRoaXMuX29wdGlvbnMuY29yZUxpYnJhcnlMb2FkZXIpIHtcbiAgICAgICAgcmV0dXJuIHRocm93RXJyb3IoJ1RoZSBmdWxsIGxpYnJhcnkgYW5kIHRoZSBjb3JlIGxpYnJhcnkgd2VyZSBpbXBvcnRlZCwgb25seSBvbmUgb2YgdGhlbSBzaG91bGQgYmUgaW1wb3J0ZWQhJyk7XG4gICAgICB9XG4gICAgICBpZiAodGhpcy5fb3B0aW9ucy5mdWxsTGlicmFyeUxvYWRlciAmJiB0aGlzLl9vcHRpb25zLmxhbmd1YWdlcykge1xuICAgICAgICByZXR1cm4gdGhyb3dFcnJvcignVGhlIGhpZ2hsaWdodGluZyBsYW5ndWFnZXMgd2VyZSBpbXBvcnRlZCB0aGV5IGFyZSBub3QgbmVlZGVkIScpO1xuICAgICAgfVxuICAgICAgaWYgKHRoaXMuX29wdGlvbnMuY29yZUxpYnJhcnlMb2FkZXIgJiYgIXRoaXMuX29wdGlvbnMubGFuZ3VhZ2VzKSB7XG4gICAgICAgIHJldHVybiB0aHJvd0Vycm9yKCdUaGUgaGlnaGxpZ2h0aW5nIGxhbmd1YWdlcyB3ZXJlIG5vdCBpbXBvcnRlZCEnKTtcbiAgICAgIH1cbiAgICAgIGlmICghdGhpcy5fb3B0aW9ucy5jb3JlTGlicmFyeUxvYWRlciAmJiB0aGlzLl9vcHRpb25zLmxhbmd1YWdlcykge1xuICAgICAgICByZXR1cm4gdGhyb3dFcnJvcignVGhlIGNvcmUgbGlicmFyeSB3YXMgbm90IGltcG9ydGVkIScpO1xuICAgICAgfVxuICAgICAgaWYgKHRoaXMuX29wdGlvbnMuZnVsbExpYnJhcnlMb2FkZXIpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMubG9hZEZ1bGxMaWJyYXJ5KCk7XG4gICAgICB9XG4gICAgICBpZiAodGhpcy5fb3B0aW9ucy5jb3JlTGlicmFyeUxvYWRlciAmJiB0aGlzLl9vcHRpb25zLmxhbmd1YWdlcyAmJiBPYmplY3Qua2V5cyh0aGlzLl9vcHRpb25zLmxhbmd1YWdlcykubGVuZ3RoKSB7XG4gICAgICAgIHJldHVybiB0aGlzLmxvYWRDb3JlTGlicmFyeSgpLnBpcGUoc3dpdGNoTWFwKChobGpzOiBIaWdobGlnaHRMaWJyYXJ5KSA9PiB0aGlzLl9sb2FkTGFuZ3VhZ2VzKGhsanMpKSk7XG4gICAgICB9XG4gICAgfVxuICAgIHJldHVybiB0aHJvd0Vycm9yKCdIaWdobGlnaHQuanMgbGlicmFyeSB3YXMgbm90IGltcG9ydGVkIScpO1xuICB9XG5cbiAgLyoqXG4gICAqIExhenktbG9hZCBoaWdobGlnaHQuanMgbGFuZ3VhZ2VzXG4gICAqL1xuICBwcml2YXRlIF9sb2FkTGFuZ3VhZ2VzKGhsanM6IEhpZ2hsaWdodExpYnJhcnkpOiBPYnNlcnZhYmxlPGFueT4ge1xuICAgIGNvbnN0IGxhbmd1YWdlcyA9IE9iamVjdC5lbnRyaWVzKHRoaXMuX29wdGlvbnMubGFuZ3VhZ2VzISkubWFwKChbbGFuZ05hbWUsIGxhbmdMb2FkZXJdKSA9PlxuICAgICAgaW1wb3J0TW9kdWxlKGxhbmdMb2FkZXIoKSkucGlwZShcbiAgICAgICAgdGFwKChsYW5nRnVuYzogYW55KSA9PiBobGpzLnJlZ2lzdGVyTGFuZ3VhZ2UobGFuZ05hbWUsIGxhbmdGdW5jKSlcbiAgICAgIClcbiAgICApO1xuICAgIHJldHVybiB6aXAoLi4ubGFuZ3VhZ2VzKS5waXBlKG1hcCgoKSA9PiBobGpzKSk7XG4gIH1cblxuXG4gIC8qKlxuICAgKiBJbXBvcnQgaGlnaGxpZ2h0LmpzIGNvcmUgbGlicmFyeVxuICAgKi9cbiAgcHJpdmF0ZSBsb2FkQ29yZUxpYnJhcnkoKTogT2JzZXJ2YWJsZTxIaWdobGlnaHRMaWJyYXJ5PiB7XG4gICAgcmV0dXJuIGltcG9ydE1vZHVsZSh0aGlzLl9vcHRpb25zLmNvcmVMaWJyYXJ5TG9hZGVyISgpKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBJbXBvcnQgaGlnaGxpZ2h0LmpzIGxpYnJhcnkgd2l0aCBhbGwgbGFuZ3VhZ2VzXG4gICAqL1xuICBwcml2YXRlIGxvYWRGdWxsTGlicmFyeSgpOiBPYnNlcnZhYmxlPEhpZ2hsaWdodExpYnJhcnk+IHtcbiAgICByZXR1cm4gaW1wb3J0TW9kdWxlKHRoaXMuX29wdGlvbnMuZnVsbExpYnJhcnlMb2FkZXIhKCkpO1xuICB9XG5cblxuICAvKipcbiAgICogSW1wb3J0IGxpbmUgbnVtYmVycyBsaWJyYXJ5XG4gICAqL1xuICBwcml2YXRlIGxvYWRMaW5lTnVtYmVycygpOiBPYnNlcnZhYmxlPGFueT4ge1xuICAgIHJldHVybiBpbXBvcnRNb2R1bGUodGhpcy5fb3B0aW9ucy5saW5lTnVtYmVyc0xvYWRlciEoKSk7XG4gIH1cbn1cblxuLyoqXG4gKiBNYXAgbG9hZGVyIHJlc3BvbnNlIHRvIG1vZHVsZSBvYmplY3RcbiAqL1xuY29uc3QgaW1wb3J0TW9kdWxlID0gKG1vZHVsZUxvYWRlcjogUHJvbWlzZTxhbnk+KTogT2JzZXJ2YWJsZTxhbnk+ID0+IHtcbiAgcmV0dXJuIGZyb20obW9kdWxlTG9hZGVyKS5waXBlKFxuICAgIGZpbHRlcigobW9kdWxlOiBhbnkpID0+ICEhbW9kdWxlICYmICEhbW9kdWxlLmRlZmF1bHQpLFxuICAgIG1hcCgobW9kdWxlOiBhbnkpID0+IG1vZHVsZS5kZWZhdWx0KVxuICApO1xufTtcbiJdfQ==